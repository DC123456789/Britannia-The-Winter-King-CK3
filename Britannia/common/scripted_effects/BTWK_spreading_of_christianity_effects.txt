BTWK_soc_situation_update_proselytization_modifiers_effect = {
	situation:spreading_of_christianity_situation = {
		every_situation_county = {
			if = {
				limit = { religion != religion:christianity_religion }
				BTWK_soc_situation_set_proselytization_modifier_effect = yes
			}
			else_if = {
				limit = { has_county_modifier = BTWK_soc_proselytization_modifier }
				remove_county_modifier = BTWK_soc_proselytization_modifier
			}
		}
	}
}

BTWK_soc_situation_set_proselytization_modifier_effect = {
	save_scope_as = current_proselytization_county
	set_global_variable = { name = soc_current_county value = scope:current_proselytization_county }

	# Calculate months remaining at current rate
	set_variable = { name = soc_proselytization_monthly_progress value = soc_proselytization_monthly_progress_value }
	if = {
		limit = { this.var:soc_proselytization_monthly_progress > 0 }
		set_variable = { 
			name = soc_proselytization_months_remaining
			value = {
				value = 100
				subtract = this.var:soc_proselytization_progress
				divide = this.var:soc_proselytization_monthly_progress
			}
		}
		set_variable = { 
			name = soc_proselytization_years_remaining
			value = {
				value = this.var:soc_proselytization_months_remaining
				divide = 12
			}
		}
	}
	else = {
		set_variable = { 
			name = soc_proselytization_months_remaining
			value = -1
		}
		set_variable = { 
			name = soc_proselytization_years_remaining
			value = -1
		}
	}
	
	# Calculate the faith that this county will convert to
	religion:christianity_religion = {
		every_faith = {
			set_variable = { name = faith_counties_count value = 0 }
		}
	}
	every_in_list = {
		variable = nearby_counties
		if = {
			limit = { religion = religion:christianity_religion }
			faith = {
				change_variable = { name = faith_counties_count add = 1 }
			}
		}
	}
	religion:christianity_religion = {
		if = {
			limit = {
				any_faith = { this.var:faith_counties_count > 0 }
			}
			random_faith = {
				limit = {
					save_temporary_scope_as = current_faith
					NOT = { 
						religion:christianity_religion = {
							any_faith = {
								this.var:faith_counties_count > scope:current_faith.var:faith_counties_count
							}
						}
					}
				}
				scope:current_proselytization_county = {
					set_variable = { name = soc_proselytization_target_faith value = prev }
				}
			}
		}
		# Get the most common Christian faith in the subregion if there are no nearby Christian provinces
		else = {
			scope:current_proselytization_county = {
				BTWK_soc_situation_get_county_region_largest_christian_faith = yes
				set_variable = { name = soc_proselytization_target_faith value = scope:region_largest_christian_faith }
			}
		}
	}
	
	# Get list of holder and current lieges of county
	clear_variable_list = county_lieges
	holder = { 
		scope:current_proselytization_county = { 
			add_to_variable_list = { name = county_lieges target = prev }
		}
		every_liege_or_above = {
			scope:current_proselytization_county = { 
				add_to_variable_list = { name = county_lieges target = prev }
			}
		}
	}
	
	# Get the list of all nearby rulers sponsoring external missionaries
	clear_variable_list = nearby_external_missionary_sponsors
	every_in_list = {
		variable = nearby_counties
		holder = {
			if = {
				limit = { 
					religion = religion:christianity_religion
					has_character_modifier = BTWK_soc_sponsoring_external_missionaries_modifier
					NOT = { 
						scope:current_proselytization_county = { 
							is_target_in_variable_list = {
								name = county_lieges
								target = prev
							}
						}
					}
				}
				scope:current_proselytization_county = { 
					add_to_variable_list = { name = nearby_external_missionary_sponsors target = prev }
				}
			}
			every_liege_or_above = {
				if = {
					limit = { 
						religion = religion:christianity_religion
						has_character_modifier = BTWK_soc_sponsoring_external_missionaries_modifier
						NOT = { 
							scope:current_proselytization_county = { 
								is_target_in_variable_list = {
									name = county_lieges
									target = prev
								}
							}
						}
					}
					scope:current_proselytization_county = { 
						add_to_variable_list = { name = nearby_external_missionary_sponsors target = prev }
					}
				}
			}
		}
	}	
	
	# Add the notification modifier
	remove_county_modifier = BTWK_soc_proselytization_modifier
	add_county_modifier = {
		modifier = BTWK_soc_proselytization_modifier
		desc = BTWK_soc_proselytization_modifier_desc_loc
	}
}

BTWK_soc_situation_calc_subregion_stats_effect = {
	BTWK_soc_situation_get_sub_region_province_effect = yes
	
	# Calculate number of counties + spreading counties for each Christian faith
	religion:christianity_religion = {
		every_faith = {
			limit = { NOT = { has_variable = block_conversion } }
			save_scope_as = current_faith
			if = {
				limit = { 
					NOT = {
						scope:sub_region_province = {
							any_in_list = {
								variable = sub_region_faith_counters
								this.var:faith ?= scope:current_faith
							}
						}
					}
				}
				scope:sub_region_province.province_owner = {
					create_story = {
						type = sub_region_faith_spread_story
						save_scope_as = sub_region_faith_spread_story
					}
				}
				scope:sub_region_faith_spread_story = {
					set_variable = { name = faith value = scope:current_faith }
				}
				scope:sub_region_province = {
					add_to_variable_list = {
						name = sub_region_faith_counters
						target = scope:sub_region_faith_spread_story
					}
				}
			}
			else = {
				scope:sub_region_province = {
					random_in_list = {
						variable = sub_region_faith_counters
						limit = { this.var:faith ?= scope:current_faith }
						save_scope_as = sub_region_faith_spread_story
					}
				}
			}
			scope:sub_region_faith_spread_story = {
				set_variable = { name = num_sub_region_counties value = 0 }
				set_variable = { name = num_sub_region_spreading_counties value = 0 }
			}
		}
	}
	
	set_local_variable = { name = num_sub_region_christian_counties value = 0 }
	set_local_variable = { name = num_sub_region_counties value = 0 }
	every_situation_sub_region_county = {
		save_scope_as = current_county
		change_local_variable = { name = num_sub_region_counties add = 1 }
		if = {
			limit = { religion = religion:christianity_religion }
			change_local_variable = { name = num_sub_region_christian_counties add = 1 }
			scope:sub_region_province = {
				random_in_list = {
					variable = sub_region_faith_counters
					limit = { this.var:faith ?= scope:current_county.faith }
					change_variable = { name = num_sub_region_counties add = 1 }
				}
			}
		}
		else_if = {
			limit = { this.var:soc_proselytization_monthly_progress > 0 }
			scope:sub_region_province = {
				random_in_list = {
					variable = sub_region_faith_counters
					limit = { this.var:faith ?= scope:current_county.var:soc_proselytization_target_faith }
					change_variable = { name = num_sub_region_spreading_counties add = 1 }
				}
			}
		}
	}
	
	# Finish getting the overall stats for each faith
	scope:sub_region_province = {
		every_in_list = {
			variable = sub_region_faith_counters
			set_variable = { 
				name = share_sub_region_faith_counties 
				value = {
					value = this.var:num_sub_region_counties
					divide = local_var:num_sub_region_christian_counties
				}
			}
		}
	}
	
	# variable_list_size doesn't seem to work right so we copy the list we want into a local list and 
	# get the size of *that*
	every_in_list = {
		list = sub_region_faith_counters_list
		remove_from_list = sub_region_faith_counters_list
	}
	every_in_list = {
		variable = sub_region_faith_counters
		add_to_temporary_list = sub_region_faith_counters_list
	}
	
	# Now make a sorted version of the list
	scope:sub_region_province = {
		clear_variable_list = sub_region_faith_counters_sorted
		ordered_in_list = {
			variable = sub_region_faith_counters
			order_by = var:num_sub_region_counties
			min = 0
			max = list_size:sub_region_faith_counters_list
			scope:sub_region_province = {
				add_to_variable_list = {
					name = sub_region_faith_counters_sorted
					target = prev
				}
			}
		}
	}
	
	# Also make sure to get the overall stats for the Christian religion as a whole
	scope:sub_region_province = { 
		set_variable = { name = num_sub_region_christian_counties value = local_var:num_sub_region_christian_counties }
		set_variable = { 
			name = share_sub_region_christian_counties 
			value = {
				value = local_var:num_sub_region_christian_counties
				divide = local_var:num_sub_region_counties
			}
		}
	}
}

BTWK_soc_situation_get_county_region_largest_christian_faith = {
	random_county_situation_sub_region = {
		limit = { 
			any_situation_sub_region_participant_group = { 
				participant_group_situation = situation:spreading_of_christianity_situation
			}
		}
		BTWK_soc_situation_get_sub_region_province_effect = yes
	}
	
	clear_saved_scope = region_largest_christian_faith
	scope:sub_region_province = {
		if = {
			limit = { has_variable_list = sub_region_faith_counters }
			random_in_list = {
				variable = sub_region_faith_counters
				limit = {
					save_temporary_scope_as = current_faith_counter
					NOT = {
						scope:sub_region_province = {
							any_in_list = {
								variable = sub_region_faith_counters
								this.var:num_sub_region_counties > scope:current_faith_counter.var:num_sub_region_counties
							}
						}
					}
					scope:current_faith_counter.var:num_sub_region_counties > 0
				}
				this.var:faith = { save_scope_as = region_largest_christian_faith }
			}
		}
	}
	
	if = {
		limit = { NOT = { exists = scope:region_largest_christian_faith } }
		faith:catholic = { save_scope_as = region_largest_christian_faith }
	}
}

BTWK_soc_situation_get_sub_region_province_effect = {
	if = {
		limit = { this = situation:spreading_of_christianity_situation.situation_sub_region:britannia }
		province:191 = { save_scope_as = sub_region_province }
	}
}

# Should be called in situation scope
BTWK_update_ai_missionary_interactions_effect = {
	# Precalculate list of in-range provinces for each ruler first
	every_situation_participant = {
		clear_variable_list = external_missionary_range_counties
		remove_variable = has_christian_or_spreading_subrealm_county
		remove_variable = has_unreformed_pagan_subrealm_county
		remove_variable = has_unreformed_pagan_missionary_range_county
	}
	every_situation_county = {
		save_scope_as = current_county
		
		# Get list of holder and current lieges of county
		clear_variable_list = county_lieges
		holder = { 
			scope:current_county = { 
				add_to_variable_list = { name = county_lieges target = prev }
			}
			every_liege_or_above = {
				scope:current_county = { 
					add_to_variable_list = { name = county_lieges target = prev }
				}
			}
		}
		
		# Every ruler that holds (directly or through a vassal) a nearby county, but not this county itself,
		# that is in external missionary range
		every_in_list = {
			variable = nearby_counties
			holder = {
				if = {
					limit = {
						NOT = { 
							scope:current_county = { 
								is_target_in_variable_list = {
									name = county_lieges
									target = prev
								}
							}
						}
					}
					add_to_variable_list = { 
						name = external_missionary_range_counties target = scope:current_county
					}
					if = {
						limit = {
							faith != scope:current_county.faith
							scope:current_county.faith = { has_doctrine_parameter = unreformed }
						}
						set_variable = has_unreformed_pagan_missionary_range_county
					}
				}
				every_liege_or_above = {
					if = {
						limit = { 
							NOT = { 
								scope:current_county = { 
									is_target_in_variable_list = {
										name = county_lieges
										target = prev
									}
								}
							}
						}
						add_to_variable_list = { 
							name = external_missionary_range_counties target = scope:current_county
						}
						if = {
							limit = {
								faith != scope:current_county.faith
								scope:current_county.faith = { has_doctrine_parameter = unreformed }
							}
							set_variable = has_unreformed_pagan_missionary_range_county
						}
					}
				}
			}
		}
		
		# Flag all rulers with Christian or Christian-spreading counties
		if = {
			limit = {
				OR = {
					religion = religion:christianity_religion
					this.var:soc_proselytization_monthly_progress > 0
				}
			}
			holder = {
				set_variable = has_christian_or_spreading_subrealm_county
				every_liege_or_above = {
					set_variable = has_christian_or_spreading_subrealm_county
				}
			}
		}
		# Flag all rulers with unreformed pagan counties
		if = {
			limit = {
				faith = { has_doctrine_parameter = unreformed }
			}
			holder = {
				if = {
					limit = { faith != scope:current_county.faith }
					set_variable = has_unreformed_pagan_subrealm_county
				}
				every_liege_or_above = {
					if = {
						limit = { faith != scope:current_county.faith }
						set_variable = has_unreformed_pagan_subrealm_county
					}
				}
			}
		}
	}
	
	# Evaluate AI logic for missionary interactions
	situation_participant_group:christian_rulers = {
		every_situation_group_participant = {
			limit = { is_ai = yes }
			# Promote Internal Missionaries:
			# - Requires >= 1 unreformed pagan province in subrealm
			# - Requires ai_zeal > 0
			# value = -25
			#	+ ai_zeal 
			# 	- ai_greed * 0.5 if ai_greed > 0
			#	+ (monthly_character_balance / monthly_character_income - 0.3) * 25 / .15 with max of 25
			#	+ 50 * share of unreformed pagan provinces in subrealm
			if = {
				limit = {
					NOT = { has_character_modifier = BTWK_soc_sponsoring_internal_missionaries_modifier }
				}
				if = {
					limit = {
						ai_zeal > 0
						BTWK_soc_internal_missionaries_score > 0
						has_variable = has_unreformed_pagan_subrealm_county
					}
					add_character_modifier = BTWK_soc_sponsoring_internal_missionaries_modifier
				}
			}
			else_if = {
				limit = {
					has_character_modifier = BTWK_soc_sponsoring_internal_missionaries_modifier
					# All interactions have some inertia
					OR = {
						ai_zeal < -15
						BTWK_soc_internal_missionaries_score < -15
						NOT = { has_variable = has_unreformed_pagan_subrealm_county }
					}
				}
				remove_character_modifier = BTWK_soc_sponsoring_internal_missionaries_modifier
			}
			set_variable = { name = BTWK_soc_internal_missionaries_score value = BTWK_soc_internal_missionaries_score }

			# Promote External Missionaries:
			# - Precalculate list of in-range provinces for each ruler first (same calculation as for calculating the spread)
			# - Requires ai_zeal > 25
			# value = -50
			#	+ ai_zeal 
			# 	- ai_greed * 0.5 if ai_greed > 0
			#	+ (monthly_character_balance / monthly_character_income - 0.3) * 30 / .15 with max of 25
			#	+ 50 * share of unreformed pagan provinces in range
			if = {
				limit = {
					NOT = { has_character_modifier = BTWK_soc_sponsoring_external_missionaries_modifier }
				}
				if = {
					limit = {
						ai_zeal > 25
						BTWK_soc_external_missionaries_score > 0
						has_variable = has_unreformed_pagan_missionary_range_county
					}
					add_character_modifier = BTWK_soc_sponsoring_external_missionaries_modifier
				}
			}
			else_if = {
				limit = {
					has_character_modifier = BTWK_soc_sponsoring_external_missionaries_modifier
					# All interactions have some inertia
					OR = {
						ai_zeal < -10
						BTWK_soc_external_missionaries_score < -15
						NOT = { has_variable = has_unreformed_pagan_missionary_range_county }
					}
				}
				remove_character_modifier = BTWK_soc_sponsoring_external_missionaries_modifier
			}			
			set_variable = { name = BTWK_soc_external_missionaries_score value = BTWK_soc_external_missionaries_score }
		}
	}
	
	situation_participant_group:non_christian_rulers = {
		every_situation_group_participant = {
			limit = { is_ai = yes }
			# Encourage Missionaries
			# - Requires >= 1 province in with positive spread in subrealm
			# - Never if ai_zeal > 25
			# value = -25
			#	- ai_zeal
			#	+ ai_rationality * 0.5
			#	- monthly_character_balance / monthly_character_income * 200, capped within 50 to -25
			if = {
				limit = {
					NOT = { has_character_modifier = BTWK_soc_encouraging_missionaries_modifier }
				}
				if = {
					limit = {
						ai_zeal <= 25
						BTWK_soc_encourage_missionaries_score > 0
						has_variable = has_christian_or_spreading_subrealm_county
					}
					add_character_modifier = BTWK_soc_encouraging_missionaries_modifier
					remove_character_modifier = BTWK_soc_banning_missionaries_modifier
				}
			}
			else_if = {
				limit = {
					has_character_modifier = BTWK_soc_encouraging_missionaries_modifier
					# All interactions have some inertia
					OR = {
						ai_zeal > 40
						BTWK_soc_encourage_missionaries_score < -15
						NOT = { has_variable = has_christian_or_spreading_subrealm_county }
					}
				}
				remove_character_modifier = BTWK_soc_encouraging_missionaries_modifier
			}
			set_variable = { name = BTWK_soc_encourage_missionaries_score value = BTWK_soc_encourage_missionaries_score }
			
			# Ban Missionaries
			# - Requires >= 1 province in with positive spread in subrealm
			# - Requires ai_zeal > 25
			# value = -25
			#	+ ai_zeal
			#	- ai_rationality * 0.5
			#	+ (monthly_character_balance / monthly_character_income - 0.1) * 100, capped within 50 to -25
			if = {
				limit = {
					NOT = { has_character_modifier = BTWK_soc_banning_missionaries_modifier }
				}
				if = {
					limit = {
						ai_zeal > 25
						BTWK_soc_ban_missionaries_score > 0
						has_variable = has_christian_or_spreading_subrealm_county
					}
					add_character_modifier = BTWK_soc_banning_missionaries_modifier
					remove_character_modifier = BTWK_soc_encouraging_missionaries_modifier
				}
			}
			else_if = {
				limit = {
					has_character_modifier = BTWK_soc_banning_missionaries_modifier
					# All interactions have some inertia
					OR = {
						ai_zeal < 10
						BTWK_soc_ban_missionaries_score < -15
						NOT = { has_variable = has_christian_or_spreading_subrealm_county }
					}
				}
				remove_character_modifier = BTWK_soc_banning_missionaries_modifier
			}
			set_variable = { name = BTWK_soc_ban_missionaries_score value = BTWK_soc_ban_missionaries_score }
		}
	}
}