@unlock_scheme_opt_out_value = 1

namespace = scheme_critical_moments

##################################################
# Seize Realm
# by Joe Parkin
# 2901 - 2910
##################################################

# Realistically, not every government type below would be valid for the scheme, but all government types have been included for completeness and mod support
scripted_effect save_target_government_as_variable_effect = {
	switch = {
		trigger = has_government
		feudal_government = {
			scope:scheme.scheme_owner = {
				save_scope_value_as = { 
					name = old_government_type
					value = flag:feudal
				}
			}
		}
		republic_government = {
			scope:scheme.scheme_owner = {
				save_scope_value_as = { 
					name = old_government_type
					value = flag:republic
				}
			}
		}
		theocracy_government = {
			scope:scheme.scheme_owner = {
				save_scope_value_as = { 
					name = old_government_type
					value = flag:theocracy
				}
			}
		}
		clan_government = {
			scope:scheme.scheme_owner = {
				save_scope_value_as = { 
					name = old_government_type
					value = flag:clan
				}
			}
		}
		tribal_government = {
			scope:scheme.scheme_owner = {
				save_scope_value_as = { 
					name = old_government_type
					value = flag:tribal
				}
			}
		}
		wanua_government = {
			scope:scheme.scheme_owner = {
				save_scope_value_as = { 
					name = old_government_type
					value = flag:wanua
				}
			}
		}
		holy_order_government = {
			scope:scheme.scheme_owner = {
				save_scope_value_as = { 
					name = old_government_type
					value = flag:holy_order
				}
			}
		}
		administrative_government = {
			scope:scheme.scheme_owner = {
				save_scope_value_as = { 
					name = old_government_type
					value = flag:administrative
				}
			}
		}
		nomad_government = {
			scope:scheme.scheme_owner = {
				save_scope_value_as = { 
					name = old_government_type
					value = flag:nomad
				}
			}
		}
		herder_government = {
			scope:scheme.scheme_owner = {
				save_scope_value_as = { 
					name = old_government_type
					value = flag:herder
				}
			}
		}
		celestial_government = {
			scope:scheme.scheme_owner = {
				save_scope_value_as = { 
					name = old_government_type
					value = flag:celestial
				}
			}
		}
		mandala_government = {
			scope:scheme.scheme_owner = {
				save_scope_value_as = { 
					name = old_government_type
					value = flag:mandala
				}
			}
		}
		steppe_admin_government = {
			scope:scheme.scheme_owner = {
				save_scope_value_as = { 
					name = old_government_type
					value = flag:steppe_admin
				}
			}
		}
		meritocratic_government = {
			scope:scheme.scheme_owner = {
				save_scope_value_as = { 
					name = old_government_type
					value = flag:meritocratic
				}
			}
		}
		japan_feudal_government = {
			scope:scheme.scheme_owner = {
				save_scope_value_as = { 
					name = old_government_type
					value = flag:japan_feudal
				}
			}
		}
		japan_administrative_government = {
			scope:scheme.scheme_owner = {
				save_scope_value_as = { 
					name = old_government_type
					value = flag:japan_administrative
				}
			}
		}
		# BTWK
		pre_feudal_government = {
			scope:scheme.scheme_owner = {
				save_scope_value_as = { 
					name = old_government_type
					value = flag:pre_feudal
				}
			}
		}
		sub_roman_government = {
			scope:scheme.scheme_owner = {
				save_scope_value_as = { 
					name = old_government_type
					value = flag:sub_roman_admin
				}
			}
		}
		sub_roman_no_dlc_government = {
			scope:scheme.scheme_owner = {
				save_scope_value_as = { 
					name = old_government_type
					value = flag:sub_roman_feudal
				}
			}
		}
		germanic_government = {
			scope:scheme.scheme_owner = {
				save_scope_value_as = { 
					name = old_government_type
					value = flag:germanic_admin
				}
			}
		}
		germanic_no_dlc_government = {
			scope:scheme.scheme_owner = {
				save_scope_value_as = { 
					name = old_government_type
					value = flag:germanic_feudal
				}
			}
		}
	}
}

#	Results event.
scheme_critical_moments.2901 = {
	hidden = yes

	immediate = {
		scope:scheme = {
			# Set up a block for the inappropriate cheating error?
			save_scope_value_as = {
				name = ignore_cheating_error_check
				value = yes
			}
			# Proceed to rolls.
			scheme_owner = {
				#DISCOVERY ROLL
				save_scope_value_as = {
					name = discovery_chance
					value = {
						value = 100
						subtract = scope:scheme.scheme_secrecy
					}
				}
				random = {
					chance = scope:discovery_chance
					save_scope_value_as = {
						name = scheme_discovered
						value = yes
					}
				}
				#SUCCESS ROLL
				random = {
					chance = scope:scheme.scheme_success_chance
					custom_tooltip = seize_realm_successful_roll_tt
					save_scope_value_as = {
						name = scheme_successful
						value = yes
					}
					mandala_trickster_increment_successful_schemes_effect = yes
				}
				# FATE ROLL
				random_list = {
					10 = {
						trigger = {
							trigger_if = {
								limit = { exists = scope:scheme_successful }
								scope:scheme.scheme_target_character = { is_ai = yes }
							}
							trigger_else = {
								scope:scheme.scheme_owner = { is_ai = yes }
							}
						}
						save_scope_as = death
					}
					10 = {
						modifier = {
							NOT = { exists = scope:scheme_successful }
							exists = scope:scheme_discovered
							factor = 2 
						}
						save_scope_as = imprison
					}
					20 = {}
				}
				# FIRE EVENTS
				if = {
					limit = { exists = scope:scheme_successful }
					scope:scheme.scheme_target_character = {
						save_target_government_as_variable_effect = yes # we need this here to build the "Has Happened" tooltip in the following event properly
					}
					trigger_event = ep3_laamps.0401
				}
				else = { trigger_event = ep3_laamps.0402 }
			}
		}
	}
}
