namespace = BTWK_story_event

################################
# THE WINTER KING STORY EVENTS #
################################

# FIRST 2 DIGITS = STORY PART; LAST 2 DIGITS = EVENT ID; 

# MAY REQUIRE A FILE FOR NON-CANON/ALT-CANON EVENTS.

# NOTICE 21/09/2023: THE EVENT WINDOWS (ANIMATIONS, THEMES, ETC.) NEED TO BE CALIBRATIED APPROPRIATELY WHEN ABLE.
# NOTICE 22/10/2023: MAY WANT TO REARRANGE EVENT IDS WHEN SECTIONS ARE MAINLY COMPLETE TO BE CHRONOLOGICAL

################################

# BTWK_story_event.setup = UTLITY: Add modifiers to story characters

### PART 1 - THE WINTER KING ###
## UTHER'S ILLNESS AND ARTHUR'S RETURN ##

# BTWK_story_event.0101 = STORYLINE TRIGGER.

# BTWK_story_event.0102 = GLEVUM: Option for independent kings to go to the High Council.
# BTWK_story_event.0103 = GLEVUM: Spring 480 AD. Start of High Council at Glevum
# BTWK_story_event.0118 = GLEVUM: Tewdric suggests to Agricola to make suggestion
# BTWK_story_event.0117 = GLEVUM: Agricola chooses whether to propose Arthur as Norwenna's Suitor
# BTWK_story_event.0113 = GLEVUM: Uther responds to Agricola's chhallege
# BTWK_story_event.0104 = GLEVUM: Select spouse for Norwenna
# BTWK_story_event.0105 = GLEVUM: Select guardians for Mordred
# BTWK_story_event.0114 = GLEVUM: Notification of the results of the council to the attendees
# BTWK_story_event.0115 = GLEVUM: Notification of the results of the council to all players in S.B. & Armorica

# BTWK_story_event.0106 = UTHER'S DEATH: Summer 480 AD. Uther Pendragon's health is worsening...
# BTWK_story_event.0107 = UTHER'S DEATH: Autumn 480 AD. If Uther is still alive, he becomes incapable...
# BTWK_story_event.0108 = UTHER'S DEATH: Uther is Dead - Hidden Effects: Triggers EVTs .0004 
# BTWK_story_event.0109 = UTHER'S DEATH: Arthur Returns - Hidden Effects: Title Swaps; Triggers EVTs .0005 & .0006
# BTWK_story_event.0110 = UTHER'S DEATH: Uther is Dead - Global Event
# BTWK_story_event.0111 = UTHER'S DEATH: Uther is Dead - Tag Switch Event for Player Mordred

# BTWK_story_event.0112 = RETURN OF ARTHUR: Arthur Introductory Event

## AFTERMATH OF UTHER'S DEATH ##

### PART 2 - THE PRINCESS BRIDE ###
## OWAIN/ARTHUR POWER STRUGGLE ##
# BTWK_story_event.0201 = Some time after betrayal/after Uther's death Cadwy sends offer to Owain

### PART 3 - THE RETURN OF MERLIN ###

### PART 4 - THE ISLE OF THE DEAD ###

### PART 5 - THE SHIELD WALL ###

### PART 6 - THE DARK ROAD ###

### PART 7 - THE BROKEN ROAD ###

### PART 8 - CAMELOT ###

### PART 9 - THE MYSTERIES OF ISIS ###

### PART 10 - THE FIRES OF MAI DUN ###

### PART 11 - MYNYDD BADDON ###

### PART 12 - NIMUE'S CURSE ###

### PART 13 - THE LAST ENCHANTMENT ###


############## UTHER'S ILLNESS and ARTHUR'S RETURN ##############

# TODO LIST:
	# ADD LOCS FOR ALL EVENTS.
	# ADD TRIGGERED DESC FOR TEWDRIC ACCEPTING THE HOSTING OF THE COUNCIL

BTWK_story_event.0101 = {  # Uther introductory event 
	type = character_event
	title = BTWK_story_event.0101.t
	desc = BTWK_story_event.0101.desc
	theme = realm 

	right_portrait = {
		character = character:1  # Uther
		animation = personality_honorable
	}	

	option = {
		name = BTWK_story_event.0101.a
		character:1 = {
			trigger_event = {
				id = BTWK_story_event.0103
				days = 50
			} 
		}

		every_ruler = {
			if = {
				limit = {
					AND = {
						holds_kingdom_near_dumnonia = yes 
						culture = {
							culture_is_brythonic_culture_trigger = yes
						}
					}
				}
				trigger_event = {
					id = BTWK_story_event.0102
					days = 25
				}
			}
		}
	}
}

BTWK_story_event.0102 = {  # Event for ai selection of whether they want to go to glevum + catalogue norwenna's suitors.

	# MAY WANT A SECOND GLOBAL VARIABLE LIST FOR ALL VALID KINGS, IN CASE WE MAKE GLEVUM INTO A RESKINNED FEAST ACTIVITY
	# IN THIS CASE, PROBABLY WANT TO REFERENCE NEW FILE SO I DON'T HAVE TO KEEP CHANGING EVENT ID - "BTWK_storyline_activity_events", etc.

	type = character_event
	title = BTWK_story_event.0102.t
	desc = BTWK_story_event.0102.desc
	theme = realm 

	right_portrait = {
		character = root  
		animation = personality_honorable
	}

	trigger = {
		character:1 = {is_alive = yes}
	}

	option = {  # Go to the council
		name = BTWK_story_event.0102.a

		if = {
			limit = {
				root = {
					is_married = no
				}
			}
			add_to_global_variable_list = {
				name = char_is_norwenna_wedding_prospect
				target = root
			}
			add_to_global_variable_list = {
				name = attending_glevum
				target = root
			}
		}

		else_if = {
			limit = {
				exists = root.primary_heir
				root.primary_heir = {
					is_adult = yes
					is_married = no
				}
			}
			add_to_global_variable_list = {
				name = char_is_norwenna_wedding_prospect
				target = root.primary_heir
			}
			add_to_global_variable_list = {
				name = attending_glevum
				target = root
			}
			add_to_global_variable_list = {
				name = attending_glevum
				target = root.primary_heir
			}
		}
	# IF CHAR = TEWDRIC OR AGRICOLA
	else_if = {
		limit = {
			OR = {
				this = character:14
				this = character:40
			}
		}
		add_to_global_variable_list = {
			name = attending_glevum
			target = this
		}
	}
	# AI CHANCE MUST STILL BE MODIFIED ACCORDINGLY
	# ADD AN OPINION BASED MODIFIER TO AI CHANCE?
		ai_chance = {
			base = 50
			modifier = {
				add = 10
				has_trait = deceitful
			}
			modifier = {
				add = -10
				has_trait = arrogant
			}
			modifier = {
				add = -10
				has_trait = vengeful
			}
			modifier = {
				add = 20
				has_trait = ambitious
			}
		}
	}

	option = {  # Don't go to the council
		name = BTWK_story_event.0102.b
		trigger = {
			NOT = {root.primary_title = title:k_gwent} #The council is being held in Gwent at Uther's demand, they can't NOT show up? 
		}
		ai_chance = {
			base = 50
		}
	}
}

BTWK_story_event.0103 = {  # Arrived at Glevum High Council. 
	type = character_event
	title = BTWK_story_event.0103.t
	desc = BTWK_story_event.0103.desc
	theme = realm
	
	right_portrait = {
		character = character:1  # Uther
		animation = personality_honorable
	}	
	left_portrait = {
		character = character:14  # Tewdric
		animation = personality_honorable
	}

	trigger = {
		character:1 = {is_alive = yes}
	}

	# Start of NORWWNNA MARRIAGE CHAIN
	option = {  
		name = BTWK_story_event.0103.a
		trigger = {
			global_variable_list_size = {
				name = char_is_norwenna_wedding_prospect
				value > 0
			} 
			character:19 = {
				is_alive = yes
			}
		}

		# Event for Tewdric
		if = {
			limit = {
				character:40 = {
					is_alive = yes
				}
				character:14 = {
					is_alive = yes
				}
			}
			character:14 = {
				trigger_event = {
					id = BTWK_story_event.0118  
					days = 1
				}
			}
		}
		
		# Skip to suitor selection if Agricola is dead.
		else = {
			character:1 = {
				trigger_event = {
					id = BTWK_story_event.0104  
					days = 1
				}
			}
		}
	}

	# If Norwenna is dead, skip to the GUARDIAN SELECTION EVENT.
	option = {  
		name = BTWK_story_event.0103.b
		trigger = {
			character:19 = {
				is_alive = no
			}
		}
		character:1 = {
			trigger_event = {
				id = BTWK_story_event.0105
				days = 1
			}
		}
	}
}

BTWK_story_event.0118 = { # Event for Tewdric: Fills player in on his opinions on bringing Arthur home
	type = character_event
	title = BTWK_story_event.0118.t
	desc = BTWK_story_event.0118.desc
	theme = realm

	option = {
		name = BTWK_story_event.0118.a
		custom_tooltip = BTWK_story_event.0118.tt_a
		character:40 = {
			trigger_event = BTWK_story_event.0117
		}
		ai_chance = {
			base = 1000
		}
	}
	option = {
		name = BTWK_story_event.0118.b
		character:40 = {
			trigger_event = BTWK_story_event
		}
		ai_chance = {
			base = 0
		}
	}
}

BTWK_story_event.0117 = {  # Event for Agricola: Decide whether to put forward Arthur as a marriage suggestion.  
	type = character_event
	title = BTWK_story_event.0117.t
	desc = BTWK_story_event.0117.desc
	theme = realm

	# Fulfil Tewdric's wishes
	option = {
		name = BTWK_story_event.0117.a
		# AGRICOLA GAINS FAVOUR ON TEWDRIC
		add_favour_hook_if_possible_simple_effect = { 
			TARGET = character:14 
		}
		character:14 = {
			add_opinion = {
				modifier = pleased_opinion 
				TARGET = character:40
				opinion = 5 # Lower opinion gain than loss as courtly liege like Tewdric would expect you to do as he commands
			}
		}
		character:1 = {
			trigger_event = {
				id = BTWK_story_event.0113
				days = 1
			}
		}
		ai_chance = {
			base = 1000
		}
	}

	# Go against Tewdric's wishes / Don't want to upset Uther.
	option = {
		name = BTWK_story_event.0117.b
		# GOING AGAINST LIEGE'S DESIRES - NOT VERY PROFESSIONAL 
		add_prestige = -100
		character:14 = {
			add_opinion = {
				modifier = frustrated_opinion 
				target = character:40
				opinion = -10
			}
		}
		character:1 = {
			trigger_event = {
				id = BTWK_story_event.0104
				days = 1
			}
		}		
		ai_chance = {
			base = 0
		}
	}
}

BTWK_story_event.0113 = {  # Event for Uther: Reaction to Agricola's suggestion.
	type = character_event
	title = BTWK_story_event.0113.t
	desc = BTWK_story_event.0113.desc
	theme = realm
	
	# UTHER REJECTS AGRICOLA'S PROPOSAL
	option = {
		name = BTWK_story_event.0113.a
		character:1 = {
			add_character_modifier = {
				modifier = story_chose_alliance_over_arthur
				years = 5
			}			
			trigger_event = {
				id = BTWK_story_event.0104
				days = 1
			}
		}
		# Add displeased opinion for Tewdric.
		ai_chance = {
			base = 1000
		}
	}

	# UTHER ACCEPTS AGRICOLA'S PROPOSAL
	option = {
		name = BTWK_story_event.0113.b
		character:1 = {
			add_stress = 100
			add_character_modifier = {
				modifier = story_chose_arthur_over_alliance
				years = 5
			}		
			trigger_event = {
				id = BTWK_story_event.0105
				days = 1
			}
		}
		character:3 = {
			marry = character:19
			remove_trait = restricted_marriage
		}
		character:19 = { 
			remove_trait = restricted_marriage 
		} 

		# Add pleased opinion modifier for tewdric
		character:40 = {
			add_character_modifier = {
				modifier = approved_by_high_king
				years = 2
			}
			# Add respect opinion modifier
		}	
		ai_chance = {
				base = 0
		}
	}
}

BTWK_story_event.0104 = {  # Choose Norwenna's suitor. 

	type = character_event
	title = BTWK_story_event.0104.t
	desc = BTWK_story_event.0104.desc
	theme = realm 

	right_portrait = {
		character = character:1  # Uther
		animation = personality_honorable
	}	
	left_portrait = {
		character = character:19
		animation = personality_honorable
	}
	# SHOULD PROBABLY HAVE AN EVENT FIRE AT SOME POINT BEFORE THE COUNCIL FOR PLAYER RULERS TO BE ABLE TO CHOOSE IF THEY OR THEIR HEIR HAVE THE MARRIAGE.
	# Done below as I have no way of distinguishing whether or not the suitor is the king or heir of a kingdom
	immediate = {
		every_in_global_list = {
			variable = char_is_norwenna_wedding_prospect
			if = {
				limit = {
					this = {
						is_married = yes
					}
				}
				remove_list_global_variable = {
					name = char_is_norwenna_wedding_prospect
					target = this
				}
			}
		}
		######## POWYS ########
		if = {
			limit = {
				any_in_global_list = {
					variable = char_is_norwenna_wedding_prospect
					has_primary_title = title:k_powys
					}
				}
			title:k_powys.holder = {
				save_scope_as = powys_suitor
			}
			var:powys_target = {
				add = 1
			}
		}
		else_if = {
			limit = {
				any_in_global_list = {
					variable = char_is_norwenna_wedding_prospect
					is_primary_heir_of = title:k_powys.holder
					holds_kingdom_near_dumnonia = no
					}
				}
			title:k_powys.holder.primary_heir = {
				save_scope_as = powys_suitor
			}
		}
		######## SILURIA ########
		if = {
			limit = {
				any_in_global_list = {
					variable = char_is_norwenna_wedding_prospect
					has_primary_title = title:k_siluria
					}
				}
			title:k_siluria.holder = {
				save_scope_as = siluria_suitor
			}
		}
		else_if = {
			limit = {
				any_in_global_list = {
					variable = char_is_norwenna_wedding_prospect
					is_primary_heir_of = title:k_siluria.holder
					holds_kingdom_near_dumnonia = no
					}
				}
			title:k_siluria.holder.primary_heir = {
				save_scope_as = siluria_suitor
			}
		}
		######## KERNOW ########
		if = {
			limit = {
				any_in_global_list = {
					variable = char_is_norwenna_wedding_prospect
					has_primary_title = title:k_kernow
					}
				}
			title:k_kernow.holder = {
				save_scope_as = kernow_suitor
			}
		}
		else_if = {
			limit = {
				any_in_global_list = {
					variable = char_is_norwenna_wedding_prospect
					is_primary_heir_of = title:k_kernow.holder
					holds_kingdom_near_dumnonia = no
					}
				}
			title:k_kernow.holder.primary_heir = {
				save_scope_as = kernow_suitor
			}
		}
		######## GWENT ########
		if = {
			limit = {
				any_in_global_list = {
					variable = char_is_norwenna_wedding_prospect
					has_primary_title = title:k_gwent
					}
				}
			title:k_gwent.holder = {
				save_scope_as = gwent_suitor
			}
		}
		else_if = {
			limit = {
				any_in_global_list = {
					variable = char_is_norwenna_wedding_prospect
					is_primary_heir_of = title:k_gwent.holder
					holds_kingdom_near_dumnonia = no
					}
				}
			title:k_gwent.holder.primary_heir = {
				save_scope_as = gwent_suitor
			}
		}
		######## GLEVUM ########
		if = {
			limit = {
				any_in_global_list = {
					variable = char_is_norwenna_wedding_prospect
					has_primary_title = title:k_glevum
					}
				}
			title:k_glevum.holder = {
				save_scope_as = glevum_suitor
			}
		}
		else_if = {
			limit = {
				any_in_global_list = {
					variable = char_is_norwenna_wedding_prospect
					is_primary_heir_of = title:k_glevum.holder
					holds_kingdom_near_dumnonia = no
					}
				}
			title:k_glevum.holder.primary_heir = {
				save_scope_as = glevum_suitor
			}
		}
		######## BELGAE ########
		if = {
			limit = {
				any_in_global_list = {
					variable = char_is_norwenna_wedding_prospect
					has_primary_title = title:k_belgae
					}
				}
			title:k_belgae.holder = {
				save_scope_as = belgae_suitor
			}
		}
		else_if = {
			limit = {
				any_in_global_list = {
					variable = char_is_norwenna_wedding_prospect
					is_primary_heir_of = title:k_belgae.holder
					holds_kingdom_near_dumnonia = no
					}
				}
			title:k_belgae.holder.primary_heir = {
				save_scope_as = belgae_suitor
			}
		}
		######## CYNWIDION ########
		if = {
			limit = {
				any_in_global_list = {
					variable = char_is_norwenna_wedding_prospect
					has_primary_title = title:k_cynwidion
					}
				}
			title:k_cynwidion.holder = {
				save_scope_as = cynwidion_suitor
			}
		}
		else_if = {
			limit = {
				any_in_global_list = {
					variable = char_is_norwenna_wedding_prospect
					is_primary_heir_of = title:k_cynwidion.holder
					holds_kingdom_near_dumnonia = no
					}
				}
			title:k_cynwidion.holder.primary_heir = {
				save_scope_as = cynwidion_suitor
			}
		}
		######## DEMETIA ########
		if = {
			limit = {
				any_in_global_list = {
					variable = char_is_norwenna_wedding_prospect
					has_primary_title = title:k_demetia
					}
				}
			title:k_demetia.holder = {
				save_scope_as = demetia_suitor
			}
		}
		else_if = {
			limit = {
				any_in_global_list = {
					variable = char_is_norwenna_wedding_prospect
					is_primary_heir_of = title:k_demetia.holder
					holds_kingdom_near_dumnonia = no
					}
				}
			title:k_demetia.holder.primary_heir = {
				save_scope_as = demetia_suitor
			}
		}
		######## ARTHUR ########
		# FOR LOC PURPOSES
		character:3 = {
			save_scope_as = prince_arthur
		}										
	}


	################### Powys ###################
	option = { 
		name = BTWK_story_event.0104.a
		trigger = {
			any_in_global_list = {
				variable = char_is_norwenna_wedding_prospect
				OR = {
					has_primary_title = title:k_powys
					AND = {
						is_primary_heir_of = title:k_powys.holder
						holds_kingdom_near_dumnonia = no
						}
					}
				}
			}
		scope:powys_suitor = {
			marry = character:19
		}
		character:1	= {
			trigger_event = BTWK_story_event.0105
		}
	}
	################### Siluria ###################
	option = { 
		name = BTWK_story_event.0104.b
		trigger = {
			any_in_global_list = {
				variable = char_is_norwenna_wedding_prospect
				OR = {
					has_primary_title = title:k_siluria
					AND = {
						is_primary_heir_of = title:k_siluria.holder
						holds_kingdom_near_dumnonia = no
						}
					}
				}
			}
		scope:siluria_suitor = {
			marry = character:19
		}
		character:1	= {
			trigger_event = BTWK_story_event.0105
		}
	}
	################### Kernow ###################
	option = { 
		name = BTWK_story_event.0104.c
		trigger = {
			any_in_global_list = {
				variable = char_is_norwenna_wedding_prospect
				OR = {
					has_primary_title = title:k_kernow
					AND = {
						is_primary_heir_of = title:k_kernow.holder
						holds_kingdom_near_dumnonia = no
						}
					}
				}
			}
		scope:kernow_suitor = {
			marry = character:19
		}
		character:1	= {
			trigger_event = BTWK_story_event.0105
		}
	}
	################### Gwent ###################
	option = { 
		name = BTWK_story_event.0104.d
		trigger = {
			any_in_global_list = {
				variable = char_is_norwenna_wedding_prospect
				OR = {
					has_primary_title = title:k_gwent
					AND = {
						is_primary_heir_of = title:k_gwent.holder
						holds_kingdom_near_dumnonia = no
						}
					}
				}
			}
		scope:gwent_suitor = {
			marry = character:19
		}
		character:1	= {
			trigger_event = BTWK_story_event.0105
		}
	}	
	################### Glevum ###################
	option = { 
		name = BTWK_story_event.0104.e
		trigger = {
			any_in_global_list = {
				variable = char_is_norwenna_wedding_prospect
				OR = {
					has_primary_title = title:k_glevum
					AND = {
						is_primary_heir_of = title:k_glevum.holder
						holds_kingdom_near_dumnonia = no
						}
					}
				}
			}
		scope:glevum_suitor = {
			marry = character:19
		}
		character:1	= {
			trigger_event = BTWK_story_event.0105
		}
	}	
	################### Belgae ###################
	option = { 
		name = BTWK_story_event.0104.f
		trigger = {
			any_in_global_list = {
				variable = char_is_norwenna_wedding_prospect
				OR = {
					has_primary_title = title:k_belgae
					AND = {
						is_primary_heir_of = title:k_belgae.holder
						holds_kingdom_near_dumnonia = no
						}
					}
				}
			}
		scope:belgae_suitor = {
			marry = character:19
		}
		character:1	= {
			trigger_event = BTWK_story_event.0105
		}
	}	
	################### Cynwidion ###################
	option = { 
		name = BTWK_story_event.0104.g
		trigger = {
			any_in_global_list = {
				variable = char_is_norwenna_wedding_prospect
				OR = {
					has_primary_title = title:k_cynwidion
					AND = {
						is_primary_heir_of = title:k_cynwidion.holder
						holds_kingdom_near_dumnonia = no
						}
					}
				}
			}
		scope:cynwidion_suitor = {
			marry = character:19
		}
		character:1	= {
			trigger_event = BTWK_story_event.0105
		}
	}	
	################### Demetia ###################
	option = { 
		name = BTWK_story_event.0104.h
		trigger = {
			any_in_global_list = {
				variable = char_is_norwenna_wedding_prospect
				OR = {
					has_primary_title = title:k_demetia
					AND = {
						is_primary_heir_of = title:k_demetia.holder
						holds_kingdom_near_dumnonia = no
						}
					}
				}
			}
		scope:demetia_suitor = {
			marry = character:19
		}
		character:1	= {
			trigger_event = BTWK_story_event.0105
		}
	}
	################### Arthur ###################	
	option = {
		name = BTWK_story_event.0104.i
		trigger = {
			character:3 = {
				is_alive = yes
			}
		}
		character:3 = {
			marry = character:19
			remove_trait = restricted_marriage
		}
		root = {
			add_stress = 100
			trigger_event = {
				id = BTWK_story_event.0105
			}
		}
		ai_chance = {
			base = -100
		}
	}
}

BTWK_story_event.0105	= {  # Guardian "Selection" Event

	# SELECTION OF GUARDIANS QUITE IRRELEVANT IN THE STORY. COULD GIVE PLAYER THE OPTION TO CHOOSE FROM REMAINING SUITORS, OR LEAVE IT AS CANON. 

	type = character_event
	title = BTWK_story_event.0105.t
	desc = BTWK_story_event.0105.desc
	theme = realm 

	right_portrait = {
		character = character:1  # Uther
		animation = personality_honorable
	}	
	lower_left_portrait = {
		character = character:5  # Mordred
		animation = no
	}
	lower_center_portrait = {
		character = character:14  # Tewdric
		animation = no
	}
	lower_right_portrait = {
		character = character:3  # Arthur
		animation = no
	}

	# NEW UTHER ALLIANCE AFTER MARRIAGE 
	immediate = {
		if = {
			limit = {
				NOT = { 
					character:3 = {
						is_spouse_of = character:19
					}
				}
			}
			# ALLIANCE: UTHER <-> NORWENNA'S SPOUSE'S FATHER IF SPOUSE UNLANDED.
			if = {
				limit = {
					character:19.primary_spouse = { 
						is_landed = no 
					}
					character:19.primary_spouse.father = { 
						is_alive = yes 
					}
				}			
				event_alliance_effect = {
					ACTOR = character:1
					TARGET = character:19.primary_spouse.father
				}
			}
			# ALLIANCE: UTHER <-> NORWENNA'S (LANDED, INDEPENDENT) SPOUSE.
			else_if = {
				limit = {
					character:19.primary_spouse = { 
						is_landed = yes
						is_independent_ruler = yes
					}
				}
				event_alliance_effect = {
					ACTOR = character:1
					TARGET = character:19.primary_spouse
				}
			}
			# ALLIANCE: UTHER <-> NORWENNA'S SPOUSE'S FATHER IF SPOUSE IS VASSAL UNDER FATHER. 
			else_if = {
				limit = {
					character:19.primary_spouse = { 
						is_landed = yes
						is_independent_ruler = no
					}
					character:19.primary_spouse.father = {
						is_alive = yes
					}
				}			
				event_alliance_effect = {
					ACTOR = character:1
					TARGET = character:19.primary_spouse.father
				}
			}
		}
	}

	option = {
		name = BTWK_story_event.0105.a

		# ADD OPINIONS FOR GUARDIANS, ETC.

		hidden_effect = { 
			# REMOVE RESTRICTED MARRIAGE TRAIT IN NEXT EVENT IN ORDER TO ALERT THE PLAYER IT HAS HAPPENED
			character:19 = { remove_trait = restricted_marriage } 
			character:1 = { 
				add_character_flag = uther_finished_glevum
				trigger_event = {
					id = BTWK_story_event.0106
					days = {30 60}
				}
			 }
			
			# NOTIFIY GLEVUM ATTENDEE PLAYERS THE CONCLUSION OF THE COUNCIL
			every_in_global_list = {
				variable = attending_glevum
				if = {
					limit = {
						is_ai = yes
						has_trait = restricted_marriage
					}
					remove_trait = restricted_marriage
				}

				else_if = {
					limit = {
						OR = {
							is_ai = no
							any_sub_realm_title = {
								this = title:c_glevum
								is_independent_ruler = yes
							}
						}
					}
					trigger_event = BTWK_story_event.0114	
				}			
				add_character_flag = attended_glevum
			}	

			set_global_variable = glevum_finished
		
			# NOTIFY SOUTH BRITANNIA & ARMORICA PLAYERS THE RESULT OF THE CONCIL
			every_player = {
				limit = {
					OR = {
						root.capital_province = {
							geographical_region = world_britannia_south
						}
 #						root.capital_province = {
 #							geographical_region = world_armorica
 #						}
					}
					NOT = {
						any_in_global_list = {
							variable = attending_glevum
						}
					}
				}
				trigger_event = BTWK_story_event.0115
			}
		}
	}
}

BTWK_story_event.0114 = {  # Notification for Glevum attendees the council is over.
	type = character_event
	title = BTWK_story_event.0114.t
	theme = realm 
	desc = {
		first_valid = {
			# NORWENNA'S NEW SPOUSE 
			triggered_desc = {
				trigger = {
					is_spouse_of = character:19
					has_trait = restricted_marriage
				}
				desc = BTWK_story_event.0114.desc.suitors_alliance
			}

			# OTHER SUITORS
			triggered_desc = {
				trigger = {
					NOT = { is_spouse_of = character:19	}
					has_trait = restricted_marriage
				}
				desc = BTWK_story_event.0114.desc.spouse_alliance
			}

			# EVERYONE ELSE FROM GLEVUM BUT UTHER
			triggered_desc = {
				trigger = {
					NOT = { is_spouse_of = character:19 }
					NOT = { has_trait = restricted_marriage }
					NOT = { has_character_flag = uther_finished_glevum}
				}
				desc = BTWK_story_event.0114.desc.others_alliance
			}

			# UTHER
			triggered_desc = {
				trigger = {
					has_character_flag = uther_finished_glevum
				}
				desc = BTWK_story_event.0114.desc.uther_alliance
			}
		}
	}

	immediate = {
		character:40 = {
			add_character_flag = owns_glevum
		}
	}
	
	option = {
		trigger = {
			has_trait = restricted_marriage
		}
		# SPOUSE
		name = { 
			trigger = {
				is_spouse_of = character:19
			}
			text = BTWK_story_event.0114.a
		}
		# SUITORS
		name = {
			trigger = {
				NOT = { is_spouse_of = character:19	}
			}
			text = BTWK_story_event.0114.b
		}
		remove_trait = restricted_marriage
	}

	# GLEVUM ATTENDEES
	option = {
		name = BTWK_story_event.0114.c
		trigger = {
			NOT = { is_spouse_of = character:19}
			NOT = { has_trait = restricted_marriage }
		}
		if = {
			limit = {
				any_sub_realm_title = {
					this = title:c_glevum
				is_independent_ruler = yes
				}
			}
			title:c_glevum = {
				add_county_modifier = {
					modifier = story_recently_hosted_high_council
					years = 2
				}
			}
		}
	}

	# UTHER
	option = {
		name = BTWK_story_event.0114.d
		trigger = {
			has_character_flag = uther_finished_glevum
		}
		character:1 = {
			trigger_event = {
				id = BTWK_story_event.0106
				days = {20 50}
			}
		}
	}
}

BTWK_story_event.0115 = {  # Notification for the South Britannia & Armorica players the results of the council
	type = character_event
	title = BTWK_story_event.0115.t
	desc = {
		desc = BTWK_story_event.0115.desc_header
		first_valid = {
			triggered_desc = {
				trigger = {
					character:19 = {
						primary_spouse = character:3
					}
				}
				desc = BTWK_story_event.0115.desc_arthur
			}
			triggered_desc = {
				triggered_desc = {
					trigger = {
						NOT = {
							character:19 = {
								primary_spouse = character:3
							}
						}
					}
				}
				desc = BTWK_story_event.0115.desc_alliance
			}
			triggered_desc = {
				triggered_desc = {
					trigger = {
						character:19 = {
							is_alive = no
						}
					}
				}
				desc = BTWK_story_event.0115.desc_norwenna_dead
			}
		}
	}
	theme = realm 

	option = {
		name = BTWK_story_event.0115.a
	}
}

BTWK_story_event.0106 = {  # Uther's health is worsening
	type = character_event
	title = BTWK_story_event.0106.t
	desc = BTWK_story_event.0106.desc
	theme = skull 

	# More fitting music cue/sounds needed
	right_portrait = {
		character = character:1  # Uther
		animation = personality_honorable
	}
	
	option = {	
		hidden_effect = {
			remove_generated_diarch_consequences_effect = {
				NEW_DIARCH = character:51
				LIEGE = holder.title:k_dumnonia
			}
		}	

		name = BTWK_story_event.0106.a
		character:1 = {
			add_trait = pneumonic
			remove_character_modifier = story_health_bonus_medium_modifier
			designate_diarch = character:51  # Father Bedwin 
			trigger_event = {
				id = BTWK_story_event.0107
				days = {50 70}
			}
		}
	}
}

BTWK_story_event.0107 = {  # Uther is now incapable
	type = character_event
	title = BTWK_story_event.0107.t
	desc = BTWK_story_event.0107.desc
	# More fitting music cue/sounds needed
	theme = skull

	right_portrait = {
		character = character:1
		animation = worry
	}
	
	option = {
		name = BTWK_story_event.0107.a
		character:1 = {
			add_trait = incapable
		}	
	}
}

BTWK_story_event.0108 = {  # Hidden trigger event to fire "Uther is dead" event and make sure the hidden effects don't fire again.

	type = character_event
	hidden = yes
	
	trigger = {
		character:1 = { is_alive = no }
		NOT = { has_global_variable = uther_is_dead }
	}


	immediate = {
		set_global_variable = uther_is_dead
		trigger_event = {
			id = BTWK_story_event.0109
		}
	}
}

BTWK_story_event.0109 = {  # Hidden effects after Uther's death
	type = character_event
	hidden = yes

	immediate = {

		#  Arthur gets d_durnac & vassals  #
		create_title_and_vassal_change = {
			type = granted
			save_scope_as = arthur_pendragon_durnac
			add_claim_on_loss = yes
		}
		title:d_centdumnonia = {
			every_de_jure_county = {
				limit = {
					holder = character:5
				}
				change_title_holder = {
					holder = character:3
					change = scope:arthur_pendragon_durnac
				}
			}
			change_title_holder = {
				holder = character:3
				change = scope:arthur_pendragon_durnac
			}
			every_de_jure_county_holder = {
				limit = {
					primary_title.duchy = title:d_centdumnonia
					liege = title:k_dumnonia.holder					
				}
				change_liege = {
					liege = character:3
					change = scope:arthur_pendragon_durnac
				}
			}
		}
		resolve_title_and_vassal_change = scope:arthur_pendragon_durnac

		# Mordred - Arthur character flags #
		# Will need to add liege change when King Ban added, OR, destroy Arthur's Company, then change employer of all chars in Arthur's Company.
		# Pendragon nickname should be added later, I think.
		character:3 = {
			add_character_flag = arthur_pendragon
		}
		character:5 = {
			add_character_flag = mordred_pendragon
		}

		# Failsafe for removing some restricted marriage traits if uther dies and glevum is cancelled.
		# Can remove when event chain definitely sound.
		character:18 = {
			remove_trait = restricted_marriage
		}
		character:12 = {
			remove_trait = restricted_marriage
		}
		character:17 = {
			remove_trait = restricted_marriage
		}
		character:19 = {
			remove_trait = restricted_marriage
		}
		################################

		# Mordred - Tewdric alliance #
		character:14 = {
			event_alliance_effect = {
				TARGET = character:5 
				ACTOR = character:14
			}
		}
		character:19.primary_spouse = {
			event_alliance_effect = {
				TARGET = character:5
				ACTOR = character:19.primary_spouse
			}
		}

		# Promise opinion modifier added to Mordred's guardians. #
		# Unsure if Merlin and Owain should have the modifier as they didn't like him.

		character:3 = {
			add_opinion = {
				target = character:5
				modifier = promise_to_predecessor
				opinion = 50
			}
		}	
		character:20 = {
			add_opinion = {
				target = character:5
				modifier = promise_to_predecessor
				opinion = 50
			}
		}	
		character:14 ={
			add_opinion = {
				target = character:5
				modifier = promise_to_predecessor
				opinion = 50
			}
		}	

		#  Fires "Uther is dead & Arthur returns" event 
		every_ruler = {
			limit = { 
				NOT = { has_character_flag = mordred_pendragon }
				NOT = { has_character_flag = arthur_pendragon }
				OR = {
					root.capital_province = { geographical_region = world_britannia_south }
					root.capital_province = { geographical_region = world_britannia_hen_ogledd }
						#geographical_region = world_hibernia
						#geographical_region = world_caledonia
						#geographical_region = world_gaul_armorica
				}
			}
			trigger_event = {  
				id = BTWK_story_event.0110
			}
		}
		character:5 = {
			trigger_event = {
				id = BTWK_story_event.0111
			}
		}
	}		
}

BTWK_story_event.0110 = {  # Global event alerting of Uther's death.
	type = character_event
	title = BTWK_story_event.0110.t
	desc = {
		desc = BTWK_story_event.0110.desc.header
		
		first_valid = {
			# Triggered desc for would be glevum attendees
			triggered_desc = {
				trigger = {
					NOT = { has_global_variable = glevum_finished }
					any_in_global_list = {
						variable = attending_glevum
					}
				}
				desc = BTWK_story_event.0110.desc.was_attending_glevum
			}
		}
		desc = BTWK_story_event.0110.desc.footer
	}
	# More fitting music cue/sounds needed
	theme = dynasty
	left_portrait = {
		character = character:3
		animation = personality_honorable
	}
	lower_right_portrait = {
		character = character:1
		animation = no
	}
	lower_center_portrait = {
		character = character:5
		animation = no
	}

		
	option = {
		# Dumnonians
		name = {
		   trigger = { 
				top_liege = { 
					has_title = title:k_dumnonia 
				}
				NOT = {
					culture = {
						has_cultural_pillar = heritage_west_germanic 
					}
				}
		    }
		   text = BTWK_story_event.0110.a
		}
		# Non-Dumnonian Brythons & Imperials.
		name = {
		   trigger = { 
				culture = {
					OR = {
						has_cultural_pillar = heritage_brythonic
						has_cultural_pillar = heritage_latin
					}
				}
				NOT = { 
					top_liege = { 
						has_title = title:k_dumnonia 
					} 
				}
		   }
		   text = BTWK_story_event.0110.b
		}

		# Is a North Sea Germanic.
		name = {
			trigger = {
				culture = { 
					has_cultural_pillar = heritage_west_germanic 
				}
			}
			text = BTWK_story_event.0110.c
		}

		# Doesn't have cultural pillars Brythonic, Latin & North Sea Germanic
		name = {
			trigger = {
				culture = {
					NOR = {
						has_cultural_pillar = heritage_brythonic 
						has_cultural_pillar = heritage_latin
						has_cultural_pillar = heritage_west_germanic
					}
				}
				NOT = {
					top_liege = { 
						has_title = title:k_dumnonia 
					}
				}
			}
			text = BTWK_story_event.0110.d
		}
	}
}

BTWK_story_event.0111 = {  # Event for Mordred: Player gets to choose to play Arthur or not.
	type = character_event
	title = BTWK_story_event.0111.t
	desc = BTWK_story_event.0111.desc
	theme = dynasty
	# More fitting sound & music cue
	left_portrait = {
		character = character:3
		animation = scheme
	}
	lower_right_portrait = {
		character = character:1
		animation = no
	}
	lower_center_portrait = {
		character = character:5
		animation = no
	}

	option = {  # Continue to play as Mordred.
		name = BTWK_story_event.0111.a
	}
	option = {  # Continue as Arthur.
		name = BTWK_story_event.0111.b
		trigger = {
			is_ai = no
		}

		set_player_character = character:3
		character:3 = {
			trigger_event = {
				id = BTWK_story_event.0112
				days = 1
			}
		}
	}
}

BTWK_story_event.0112 = {  # Event for Arthur: Flavour text for the player. 
	type = character_event
	title = BTWK_story_event.0112.t
	desc = BTWK_story_event.0112.desc
	theme = dynasty

	right_portrait = {
		character = root
		animation = personality_honorable
	}
	option = {
		name = BTWK_story_event.0112.a
	}
}