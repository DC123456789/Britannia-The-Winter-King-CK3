namespace = BTWK_story_event

################################
# THE WINTER KING STORY EVENTS #
################################

# CURRENTLY JUST PORTS FROM CKII. AMENDMENTS TO MAKE THEM CLOSER TO THE STORY SHOULD BE COMPLETED AS REQUIRED.

################################

### UTHER'S DEATH and ARTHUR'S RETURN ###
# BTWK_story_event.0001 = Autumn 480 AD. Uther Pendragon health is worsening...
# BTWK_story_event.0002 = January 481 AD. If Uther still alive, he becomes incapable...
# BTWK_story_event.0003 = Uther is Dead - Hidden Effects: Triggers EVTs .0004 
# BTWK_story_event.0004 = Arthur Returns - Hidden Effects: Title Swaps; Triggers EVTs .0005 & .0006
# BTWK_story_event.0005 = Uther is Dead global ping
# BTWK_story_event.0006 = Unique event for player controlled mordred allowing tag switch to arthur
# BTWK_story_event.0007 = Arthur introduction event

### ARTHUR REGENCY CHAIN ###
# BTWK_story_event.0008 = Regent decides to give power to Arthur
# BTWK_story_event.0009 = Arthur accepts regency
# BTWK_story_event.0010 = Notify Mordred
# BTWK_story_event.0011 = Notify other vassals
# BTWK_story_event.0012 = Set Flag


############## UTHER'S DEATH and ARTHUR'S RETURN ##############


BTWK_story_event.0001 = {  # Triggered by on_game_start on_action.
	type = character_event
	title = BTWK_story_event.0001.t
	desc = BTWK_story_event.0001.desc
	# More fitting music cue/sounds needed
	theme = skull
	# Won't use "window = fullscreen_event" until figure out how to add portraits to the event.
	
	right_portrait = {
		character = character:1  # Uther
		animation = worry
	}	
	lower_left_portrait = {
		character = character:5  # Mordred ap Mordred
		animation = no
	}
	lower_center_portrait = {
		character = character:2  # Merlin
		animation = no
	}
	lower_right_portrait = {
		character = character:3  # Arthur
		animation = no
	}
	
	option = {
		name = BTWK_story_event.0001.a
		set_global_variable = utherillness
		character:1 = {
			add_trait = pneumonic
			add_character_flag = utherillness
			if = {
				limit = { NOT = { has_global_variable = utherincapable } }
				trigger_event = {
					id = BTWK_story_event.0002
					days = {100 180}
				}
			}
		}
	}
}

BTWK_story_event.0002 = {  # Should probably change this to make it non-hidden & a unique end of life event for Uther.
	type = character_event
	title = BTWK_story_event.0002.t
	desc = BTWK_story_event.0002.desc
	# More fitting music cue/sounds needed
	theme = skull


	right_portrait = {
		character = character:1
		animation = worry
	}
	
	option = {
		name = BTWK_story_event.0002.a
		character:1 = {
			add_trait = incapable
			set_global_variable = utherincapable
		}
		
	}
}

BTWK_story_event.0003 = {  #Sub-event that delays Arthur's return, & fires "Uther is dead" event.

	type = character_event
	hidden = yes
	
	trigger = {
		character:1 = { is_alive = no }
		NOT = { has_global_variable = uther_is_dead }
	}
	immediate = {
		set_global_variable = uther_is_dead
		#  Fires Arthur's return HIDDEN EVENT  #
		trigger_event = {
			id = BTWK_story_event.0004
		}
	}
}

BTWK_story_event.0004 = {

	type = character_event
	hidden = yes

	immediate = {

		#  Arthur gets d_durnac & vassals  #
		create_title_and_vassal_change = {
			type = granted
			save_scope_as = arthur_pendragon_durnac
			add_claim_on_loss = yes
		}
		title:d_centdumnonia = {
			every_de_jure_county = {
				limit = {
					holder = character:5
				}
				change_title_holder = {
					holder = character:3
					change = scope:arthur_pendragon_durnac
				}
			}
			change_title_holder = {
				holder = character:3
				change = scope:arthur_pendragon_durnac
			}
			every_de_jure_county_holder = {
				limit = {
					# Don't need highest title <= county limit
					capital_county.duchy = title:d_centdumnonia
					primary_title.duchy = title:d_centdumnonia
					liege = title:k_dumnonia.holder					
				}
				change_liege = {
					liege = character:3
					change = scope:arthur_pendragon_durnac
				}
			}
		}
		resolve_title_and_vassal_change = scope:arthur_pendragon_durnac
		#####################################

		# Will need to add liege change when King Ban added, OR, destroy Arthur's Company, then change employer of all chars in Arthur's Company.
		character:3 = {
			add_character_flag = arthur_pendragon
			give_nickname = nick_pendragon
		}
		character:5 = {
			add_character_flag = mordred_pendragon
		}

		#  Fires "Uther is dead & Arthur returns" event  #
		every_ruler = {
			limit = { 
				NOT = { has_character_flag = mordred_pendragon }
				NOT = { has_character_flag = arthur_pendragon }
			}
			trigger_event = {  
				id = BTWK_story_event.0005
			}
		}
		character:5 = {
			trigger_event = {
				id = BTWK_story_event.0006
			}
		}
	}		
}

BTWK_story_event.0005 = { 
	
	type = character_event
	title = BTWK_story_event.0005.t
	desc = BTWK_story_event.0005.desc
# More fitting music cue/sounds needed
	theme = dynasty
	left_portrait = {
		character = character:3
		animation = personality_honorable
	}
	lower_right_portrait = {
		character = character:1
		animation = no
	}
	lower_center_portrait = {
		character = character:5
		animation = no
	}


# Dumnonians	
	option = { 												
		name = BTWK_story_event.0005.a
		trigger = {
			top_liege = { has_title = title:k_dumnonia }
			NOT = {
				culture = {has_cultural_pillar = heritage_west_germanic }
			}

		}
	}	

# Non-Dumnonian Brythons & Imperials.
	option = { 												
		name = BTWK_story_event.0005.b
		trigger = {	
			culture = {
				OR = {
					has_cultural_pillar = heritage_brythonic
					has_cultural_pillar = heritage_latin
				}
			}
			NOT = { top_liege = { has_title = title:k_dumnonia } }
		}
	}

# Is a North Sea Germanic.
	option = {  											
		name = BTWK_story_event.0005.c
		trigger = {
			culture = { has_cultural_pillar = heritage_west_germanic }
		}
	}
	

# Doesn't have cultural pillars Brythonic, Latin & North Sea Germanic, and NOT located in key "Britannia" regions.
	option = {  											
		name = BTWK_story_event.0005.d
		trigger = {
			culture = {
				NOR = {
					has_cultural_pillar = heritage_brythonic 
					has_cultural_pillar = heritage_latin
					has_cultural_pillar = heritage_west_germanic
				}
			}
			NOT = {top_liege = { has_title = title:k_dumnonia }}
		}
	}
}


BTWK_story_event.0006 = {
	type = character_event
	title = BTWK_story_event.0006.t
	desc = BTWK_story_event.0006.desc
	theme = dynasty
	# More fitting sound & music cue
	left_portrait = {
		character = character:3
		animation = scheme
	}
	lower_right_portrait = {
		character = character:1
		animation = no
	}
	lower_center_portrait = {
		character = character:5
		animation = no
	}

	option = {  # Continue to play as Mordred.
		name = BTWK_story_event.0006.a
	}
	option = {  # Continue as Arthur.
		name = BTWK_story_event.0006.b
		trigger = {
			is_ai = no
		}

		# Doesn't work correctly #
		character:3 = {
			trigger_event = {
				id = BTWK_story_event.0007
				days = 1
			}
		}
		##########################

		set_player_character = character:3		
	}
}

BTWK_story_event.0007 = {
	type = character_event
	title = BTWK_story_event.0007.t
	desc = BTWK_story_event.0007.desc
	theme = dynasty

	right_portrait = {
		character = root
		animation = personality_honorable
	}
	trigger = {
		this = character:3
		is_ai = no
	}
	option = {
		name = BTWK_story_event.0007.a
	}
}

############## ARTHUR REGENCY CHAIN ##############
# WILL NOT FIRE - DECISION NEEDS TO BE MADE
BTWK_story_event.0008 = {	# Regent decides to give power to Arthur
	type = character_event
	title = BTWK_story_event.0008.t
	theme = dynasty
	
	desc = {
		desc = BTWK_story_event.0008.desc
		first_valid = {
			triggered_desc = { 
				trigger = {
					NOT = { has_character_flag = arthur_regent }
				}
				desc = BTWK_story_event.0007.desc_arthur_regent_1

			}
			triggered_desc = {
				trigger = {
					has_character_flag = arthur_regent
				}
				desc = BTWK_story_event.0007.desc_arthur_regent_2
			}

		}
	}
	

	trigger = {
		# NOT Arthur, NOT Mordred, Dumnonia has active diarchy, diarch/regent = ROOT. Arthur has returned & has NOT refused regent previously.
		NOT = {
			this = character:3
			this = character:5
		}
		# May have teething troubles with regency triggers. No documentation on the Wiki nor CK3 Co-Op.
		character:5 = {
			has_active_diarchy = yes
			diarch = ROOT
		}
		character:3 = {

		}
		}
		
	
	
	immediate = {
		add_character_flag = old_dumnonia_regent
	}
	
	option = {
		name = BTWK_story_event.0008.a
		ai_chance = {
			base = 100
		}
#		character:3 = {
#			trigger_event = { 
#				id = BTWK_story_event.0009
#				days = 1 
#			}
#		}
	}
	
	option = {
		name = BTWK_story_event.0008.b
		ai_chance = {
			base = 0
		}
		add_character_flag = refused_arthur_regent
	}
}